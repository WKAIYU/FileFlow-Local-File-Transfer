<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°æ–‡ä»¶ä¼ è¾“ç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: #2575fc;
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 30px;
        }
        
        .upload-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            border-right: 1px solid #eee;
        }
        
        .files-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        h2 {
            color: #2575fc;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .upload-area {
            border: 2px dashed #2575fc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .upload-area:hover {
            background: #f8fbff;
            border-color: #6a11cb;
        }
        
        .upload-area.active {
            background: #f0f7ff;
            border-color: #6a11cb;
        }
        
        .upload-area i {
            font-size: 50px;
            color: #2575fc;
            margin-bottom: 15px;
        }
        
        .upload-area p {
            margin-bottom: 15px;
            color: #666;
        }
        
        .pending-files {
            margin-top: 15px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .pending-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #2575fc;
        }
        
        .pending-file-name {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .pending-file-size {
            font-size: 0.8rem;
            color: #666;
            margin-left: 10px;
        }
        
        .btn {
            background: #2575fc;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #6a11cb;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .file-list {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: #f8fbff;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .file-meta {
            font-size: 0.85rem;
            color: #888;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .delete-btn:hover {
            background: #ff3742;
            transform: scale(1.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        
        .empty-state i {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        .ip-display {
            background: #f0f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #2575fc;
        }
        
        .ip-address {
            font-family: monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2575fc;
            margin: 10px 0;
        }
        
        .copy-btn {
            background: #6a11cb;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .copy-btn:hover {
            background: #5a0db3;
        }
        
        .connection-status {
            margin-top: 20px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #2ed573;
        }
        
        .status-offline {
            background: #ff4757;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        
        .progress {
            height: 100%;
            background: #2575fc;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 25px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #2575fc;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .close-btn:hover {
            color: #ff4757;
        }
        
        .file-conflict-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .file-conflict-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .file-conflict-name {
            flex: 1;
            font-weight: 500;
        }
        
        .file-conflict-actions {
            display: flex;
            gap: 10px;
        }
        
        .rename-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .rename-btn {
            background: #2575fc;
            color: white;
        }
        
        .rename-btn:hover {
            background: #1c68e0;
        }
        
        .skip-btn {
            background: #ffa502;
            color: white;
        }
        
        .skip-btn:hover {
            background: #e59400;
        }
        
        .replace-btn {
            background: #ff4757;
            color: white;
        }
        
        .replace-btn:hover {
            background: #ff3742;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .upload-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .file-conflict-actions {
                flex-direction: column;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æœ¬åœ°æ–‡ä»¶ä¼ è¾“ç«™</h1>
            <p class="subtitle">åœ¨å±€åŸŸç½‘å†…å¿«é€Ÿåˆ†äº«æ–‡ä»¶ - å¯è§†åŒ–ä¸Šä¼ </p>
        </header>
        
        <div class="main-content">
            <section class="upload-section">
                <div class="card">
                    <h2>ä¸Šä¼ æ–‡ä»¶</h2>
                    <div class="upload-area" id="uploadArea">
                        <i>ğŸ“</i>
                        <p>æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                        <p class="small">æ”¯æŒå•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ä¸Šä¼ </p>
                        <div class="pending-files" id="pendingFiles">
                            <!-- å‡†å¤‡ä¸Šä¼ çš„æ–‡ä»¶å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn" id="uploadBtn">å¼€å§‹ä¸Šä¼ </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>ä½¿ç”¨è¯´æ˜</h2>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li>ä¸Šä¼ æ–‡ä»¶åï¼Œå…¶ä»–è®¾å¤‡åœ¨åŒä¸€ç½‘ç»œä¸‹è®¿é—®æ­¤é¡µé¢å³å¯ä¸‹è½½</li>
                        <li>æ‰€æœ‰è®¾å¤‡çœ‹åˆ°çš„æ–‡ä»¶åˆ—è¡¨æ˜¯ç›¸åŒçš„</li>
                        <li>æ–‡ä»¶å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šï¼Œåˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±</li>
                        <li>æ”¯æŒæ‰€æœ‰ç±»å‹çš„æ–‡ä»¶ä¼ è¾“</li>
                        <li>æœ€å¤§æ”¯æŒå•ä¸ªæ–‡ä»¶100MB</li>
                        <li><strong>æ–°å¢</strong>: å¯è§†åŒ–ä¸Šä¼ æ–‡ä»¶é¢„è§ˆ</li>
                        <li><strong>æ–°å¢</strong>: è‡ªåŠ¨ä¿®å¤ä¸­æ–‡æ–‡ä»¶åä¹±ç é—®é¢˜</li>
                    </ul>
                </div>
            </section>
            
            <section class="files-section">
                <div class="card">
                    <h2>å·²ä¸Šä¼ æ–‡ä»¶ <span id="fileCount">(0)</span></h2>
                    <ul class="file-list" id="fileList">
                        <div class="empty-state">
                            <i>ğŸ“„</i>
                            <p>æš‚æ— æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ æ–‡ä»¶</p>
                        </div>
                    </ul>
                </div>
                
                <div class="card">
                    <h2>æœåŠ¡å™¨ä¿¡æ¯</h2>
                    <div style="line-height: 1.6;">
                        <p><strong>è®¿é—®åœ°å€:</strong></p>
                        <div class="ip-display">
                            <p>å…¶ä»–è®¾å¤‡è¯·è®¿é—®:</p>
                            <div class="ip-address" id="ipAddress">æ­£åœ¨æ£€æµ‹IPåœ°å€...</div>
                            <button class="copy-btn" id="copyIpBtn">å¤åˆ¶åœ°å€</button>
                            <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                ç«¯å£: <span id="portDisplay">3000</span>
                            </p>
                        </div>
                        
                        <div class="connection-status">
                            <div class="status-indicator">
                                <div class="status-dot status-online" id="serverStatus"></div>
                                <span id="serverStatusText">æœåŠ¡å™¨è¿è¡Œä¸­</span>
                            </div>
                        </div>
                        
                        <p style="margin-top: 15px;"><strong>è¿è¡Œæ—¶é—´:</strong> <span id="uptime">0 å°æ—¶ 0 åˆ†é’Ÿ</span></p>
                    </div>
                </div>
            </section>
        </div>
        
        <footer>
            <p>æœ¬åœ°æ–‡ä»¶ä¼ è¾“æœåŠ¡ &copy; wkaiyu | å¯è§†åŒ–ä¸Šä¼ ä½“éªŒ</p>
        </footer>
    </div>

    <!-- æ–‡ä»¶åå†²çªå¤„ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="fileConflictModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ–‡ä»¶åå†²çª</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <p>ä»¥ä¸‹æ–‡ä»¶ä¸æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶é‡åï¼Œè¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š</p>
            <div class="file-conflict-list" id="fileConflictList">
                <!-- å†²çªæ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="text-align: right;">
                <button class="btn" id="confirmUpload">ç¡®è®¤ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <script>
        // DOMå…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const ipAddress = document.getElementById('ipAddress');
        const copyIpBtn = document.getElementById('copyIpBtn');
        const portDisplay = document.getElementById('portDisplay');
        const uptime = document.getElementById('uptime');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const serverStatus = document.getElementById('serverStatus');
        const serverStatusText = document.getElementById('serverStatusText');
        const pendingFilesContainer = document.getElementById('pendingFiles');
        
        // æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
        const fileConflictModal = document.getElementById('fileConflictModal');
        const fileConflictList = document.getElementById('fileConflictList');
        const closeModal = document.getElementById('closeModal');
        const confirmUpload = document.getElementById('confirmUpload');
        
        let serverStartTime = new Date();
        let files = [];
        let pendingFiles = []; // å¾…å¤„ç†çš„æ–‡ä»¶
        let fileRenames = {}; // æ–‡ä»¶é‡å‘½åæ˜ å°„
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æµ‹IPåœ°å€
            detectIPAddress();
            
            // è·å–æ–‡ä»¶åˆ—è¡¨
            loadFiles();
            
            // è®¾ç½®è¿è¡Œæ—¶é—´
            setInterval(updateUptime, 60000);
            updateUptime();
            
            // å®šæœŸåˆ·æ–°æ–‡ä»¶åˆ—è¡¨
            setInterval(loadFiles, 5000);
            
            // äº‹ä»¶ç›‘å¬
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('active');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('active');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('active');
                handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    handleFiles(fileInput.files);
                }
            });
            
            uploadBtn.addEventListener('click', checkFileConflicts);
            
            copyIpBtn.addEventListener('click', copyIPAddress);
            
            // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
            checkServerStatus();
            
            // æ¨¡æ€æ¡†äº‹ä»¶
            closeModal.addEventListener('click', () => {
                fileConflictModal.style.display = 'none';
            });
            
            confirmUpload.addEventListener('click', uploadFiles);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', (e) => {
                if (e.target === fileConflictModal) {
                    fileConflictModal.style.display = 'none';
                }
            });
        });
        
        // æ£€æµ‹IPåœ°å€
        function detectIPAddress() {
            // å°è¯•é€šè¿‡WebRTCè·å–æœ¬åœ°IP
            const RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
            
            if (RTCPeerConnection) {
                const rtc = new RTCPeerConnection({iceServers:[]});
                rtc.createDataChannel('', {reliable:false});
                
                rtc.onicecandidate = function(evt) {
                    if (evt.candidate) {
                        const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
                        const ipMatch = ipRegex.exec(evt.candidate.candidate);
                        if (ipMatch) {
                            const ip = ipMatch[1];
                            displayIPAddress(ip);
                            rtc.close();
                        }
                    }
                };
                
                rtc.createOffer()
                .then(offer => rtc.setLocalDescription(offer))
                .catch(e => console.error(e));
                
                // å¦‚æœWebRTCæ–¹æ³•å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
                setTimeout(() => {
                    if (ipAddress.textContent === 'æ­£åœ¨æ£€æµ‹IPåœ°å€...') {
                        getIPFromAPI();
                    }
                }, 2000);
            } else {
                getIPFromAPI();
            }
        }
        
        // ä»APIè·å–IPåœ°å€ï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
        function getIPFromAPI() {
            // æ³¨æ„ï¼šè¿™ç§æ–¹æ³•è·å–çš„æ˜¯å…¬ç½‘IPï¼Œä¸æ˜¯å±€åŸŸç½‘IP
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    displayIPAddress(data.ip);
                })
                .catch(error => {
                    console.error('è·å–IPåœ°å€å¤±è´¥:', error);
                    displayIPAddress('æ— æ³•è·å–IPåœ°å€ï¼Œè¯·æ‰‹åŠ¨æŸ¥çœ‹');
                });
        }
        
        // æ˜¾ç¤ºIPåœ°å€
        function displayIPAddress(ip) {
            const port = window.location.port || '3000';
            ipAddress.textContent = `http://${ip}:${port}`;
            portDisplay.textContent = port;
        }
        
        // å¤åˆ¶IPåœ°å€
        function copyIPAddress() {
            const textArea = document.createElement('textarea');
            textArea.value = ipAddress.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            const originalText = copyIpBtn.textContent;
            copyIpBtn.textContent = 'å·²å¤åˆ¶!';
            setTimeout(() => {
                copyIpBtn.textContent = originalText;
            }, 2000);
        }
        
        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        function checkServerStatus() {
            fetch('/api/files')
                .then(response => {
                    if (response.ok) {
                        serverStatus.className = 'status-dot status-online';
                        serverStatusText.textContent = 'æœåŠ¡å™¨è¿è¡Œä¸­';
                    } else {
                        serverStatus.className = 'status-dot status-offline';
                        serverStatusText.textContent = 'æœåŠ¡å™¨è¿æ¥å¤±è´¥';
                    }
                })
                .catch(error => {
                    console.error('æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
                    serverStatus.className = 'status-dot status-offline';
                    serverStatusText.textContent = 'æœåŠ¡å™¨è¿æ¥å¤±è´¥';
                });
        }
        
        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        function loadFiles() {
            fetch('/api/files')
                .then(response => response.json())
                .then(data => {
                    files = data;
                    renderFileList();
                })
                .catch(error => {
                    console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                });
        }
        
        // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
        function handleFiles(fileList) {
            pendingFiles = Array.from(fileList);
            renderPendingFiles();
            
            // å¯ç”¨ä¸Šä¼ æŒ‰é’®
            uploadBtn.disabled = false;
        }
        
        // æ¸²æŸ“å¾…ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
        function renderPendingFiles() {
            if (pendingFiles.length === 0) {
                pendingFilesContainer.innerHTML = '';
                return;
            }
            
            pendingFilesContainer.innerHTML = '';
            
            pendingFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'pending-file-item';
                
                const fileName = document.createElement('div');
                fileName.className = 'pending-file-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'pending-file-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileItem.appendChild(fileName);
                fileItem.appendChild(fileSize);
                
                pendingFilesContainer.appendChild(fileItem);
            });
        }
        
        // æ£€æŸ¥æ–‡ä»¶å†²çª
        function checkFileConflicts() {
            if (!pendingFiles || pendingFiles.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
                return;
            }
            
            const conflicts = [];
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶åå†²çª
            pendingFiles.forEach(file => {
                const fileName = file.name;
                if (files.some(f => f.name === fileName)) {
                    conflicts.push({
                        file: file,
                        originalName: fileName,
                        action: 'rename', // é»˜è®¤é‡å‘½å
                        newName: fileName
                    });
                }
            });
            
            if (conflicts.length > 0) {
                // æ˜¾ç¤ºå†²çªå¤„ç†æ¨¡æ€æ¡†
                showFileConflictModal(conflicts);
            } else {
                // æ²¡æœ‰å†²çªï¼Œç›´æ¥ä¸Šä¼ 
                uploadFiles();
            }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶å†²çªæ¨¡æ€æ¡†
        function showFileConflictModal(conflicts) {
            fileConflictList.innerHTML = '';
            fileRenames = {};
            
            conflicts.forEach(conflict => {
                const conflictItem = document.createElement('div');
                conflictItem.className = 'file-conflict-item';
                
                conflictItem.innerHTML = `
                    <div class="file-conflict-name">${conflict.originalName}</div>
                    <div class="file-conflict-actions">
                        <input type="text" class="rename-input" value="${conflict.originalName}" 
                               data-original="${conflict.originalName}">
                        <button class="action-btn rename-btn" data-action="rename">é‡å‘½å</button>
                        <button class="action-btn skip-btn" data-action="skip">è·³è¿‡</button>
                        <button class="action-btn replace-btn" data-action="replace">æ›¿æ¢</button>
                    </div>
                `;
                
                fileConflictList.appendChild(conflictItem);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                const renameInput = conflictItem.querySelector('.rename-input');
                const renameBtn = conflictItem.querySelector('.rename-btn');
                const skipBtn = conflictItem.querySelector('.skip-btn');
                const replaceBtn = conflictItem.querySelector('.replace-btn');
                
                renameBtn.addEventListener('click', () => {
                    const newName = renameInput.value.trim();
                    if (newName && newName !== conflict.originalName) {
                        fileRenames[conflict.originalName] = {
                            action: 'rename',
                            newName: newName
                        };
                        conflictItem.style.background = '#e8f4ff';
                    }
                });
                
                skipBtn.addEventListener('click', () => {
                    fileRenames[conflict.originalName] = {
                        action: 'skip'
                    };
                    conflictItem.style.background = '#fff3cd';
                });
                
                replaceBtn.addEventListener('click', () => {
                    fileRenames[conflict.originalName] = {
                        action: 'replace'
                    };
                    conflictItem.style.background = '#f8d7da';
                });
            });
            
            fileConflictModal.style.display = 'block';
        }
        
        // ä¸Šä¼ æ–‡ä»¶
        function uploadFiles() {
            // ç¦ç”¨ä¸Šä¼ æŒ‰é’®
            uploadBtn.disabled = true;
            
            const formData = new FormData();
            let filesToUpload = pendingFiles;
            
            // åº”ç”¨é‡å‘½åå’Œè·³è¿‡é€»è¾‘
            if (Object.keys(fileRenames).length > 0) {
                filesToUpload = pendingFiles.filter(file => {
                    const renameInfo = fileRenames[file.name];
                    if (!renameInfo || renameInfo.action === 'skip') {
                        return false; // è·³è¿‡è¿™ä¸ªæ–‡ä»¶
                    }
                    return true; // ä¸Šä¼ è¿™ä¸ªæ–‡ä»¶
                });
                
                // å¯¹äºé‡å‘½åçš„æ–‡ä»¶ï¼Œä¿®æ”¹æ–‡ä»¶å
                filesToUpload = filesToUpload.map(file => {
                    const renameInfo = fileRenames[file.name];
                    if (renameInfo && renameInfo.action === 'rename') {
                        // åˆ›å»ºä¸€ä¸ªæ–°çš„Fileå¯¹è±¡ï¼Œä½¿ç”¨æ–°æ–‡ä»¶å
                        return new File([file], renameInfo.newName, {
                            type: file.type,
                            lastModified: file.lastModified
                        });
                    }
                    return file;
                });
            }
            
            if (filesToUpload.length === 0) {
                alert('æ²¡æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ ');
                uploadBtn.disabled = false;
                fileConflictModal.style.display = 'none';
                return;
            }
            
            for (let i = 0; i < filesToUpload.length; i++) {
                formData.append('files', filesToUpload[i]);
            }
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressBar.style.display = 'block';
            progress.style.width = '0%';
            
            // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
            let progressValue = 0;
            const progressInterval = setInterval(() => {
                progressValue += 5;
                progress.style.width = `${progressValue}%`;
                if (progressValue >= 90) {
                    clearInterval(progressInterval);
                }
            }, 100);
            
            // å‘é€ä¸Šä¼ è¯·æ±‚
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                progress.style.width = '100%';
                
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    alert(data.message);
                    
                    // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                    loadFiles();
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    fileInput.value = '';
                    
                    // æ¸…ç©ºå¾…ä¸Šä¼ æ–‡ä»¶
                    pendingFiles = [];
                    renderPendingFiles();
                    
                    // é‡æ–°å¯ç”¨ä¸Šä¼ æŒ‰é’®
                    uploadBtn.disabled = false;
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    fileConflictModal.style.display = 'none';
                    
                    // æ¸…ç©ºä¸´æ—¶æ•°æ®
                    fileRenames = {};
                }, 500);
            })
            .catch(error => {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                clearInterval(progressInterval);
                progressBar.style.display = 'none';
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
                uploadBtn.disabled = false;
                fileConflictModal.style.display = 'none';
            });
        }
        
        // åˆ é™¤æ–‡ä»¶
        function deleteFile(fileId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                return;
            }
            
            fetch(`/api/file/${fileId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadFiles();
            })
            .catch(error => {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
        
        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList() {
            fileCount.textContent = `(${files.length})`;
            
            if (files.length === 0) {
                fileList.innerHTML = `
                    <div class="empty-state">
                        <i>ğŸ“„</i>
                        <p>æš‚æ— æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ æ–‡ä»¶</p>
                    </div>
                `;
                return;
            }
            
            fileList.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('li');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">${file.size} Â· ${file.uploadTime}</div>
                    </div>
                    <div class="file-actions">
                        <a href="${file.path}" download="${file.name}" class="btn">ä¸‹è½½</a>
                        <button class="delete-btn" data-id="${file.id}">Ã—</button>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });
            
            // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const fileId = this.getAttribute('data-id');
                    deleteFile(fileId);
                });
            });
        }
        
        // æ›´æ–°è¿è¡Œæ—¶é—´
        function updateUptime() {
            const now = new Date();
            const diff = now - serverStartTime;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            uptime.textContent = `${hours} å°æ—¶ ${minutes} åˆ†é’Ÿ`;
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>